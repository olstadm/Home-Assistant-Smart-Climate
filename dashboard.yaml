title: Home
path: home
icon: mdi:home-thermometer
sections:
  - type: grid
    columns: 1
    cards:
      - type: heading
        heading: Forecast
      - square: false
        type: grid
        cards:
          - type: custom:apexcharts-card
            header:
              title: Indoor Temperature Forecast (13h - ML Enhanced)
              show: true
            graph_span: 13h
            span:
              start: hour
              offset: -1h
            now:
              show: true
              label: Now
            apex_config:
              chart:
                height: 360
              legend:
                show: true
                position: top
              xaxis:
                labels:
                  formatter: |
                    EVAL:function(val) { 
                      return new Date(val).toLocaleTimeString('en', {hour: '2-digit', minute: '2-digit'});
                    }
            yaxis:
              - decimals: 0
                apex_config:
                  labels:
                    formatter: |
                      EVAL:function(val){return `${Math.round(val)}°F`}
            series:
              - entity: sensor.home_model_indoor_forecast_12h
                name: Indoor (Idle)
                type: line
                data_generator: >
                  return entity.attributes.series_idle.map(p => [new
                  Date(p.t).getTime(), p.y]);
              - entity: sensor.home_model_indoor_forecast_12h
                name: Indoor (Controlled)
                type: line
                stroke_width: 3
                data_generator: >
                  if (!entity.attributes.series_controlled) return [];

                  return entity.attributes.series_controlled.map(p => [new
                  Date(p.t).getTime(), p.y]);
              - entity: sensor.home_model_ml_enhanced_prediction
                name: ML Enhanced
                type: line
                stroke_width: 2
                color: '#ff6b35'
                data_generator: >
                  const now = new Date();
                  const enhanced = parseFloat(entity.state) || 0;
                  return [[now.getTime(), enhanced]];
              - entity: sensor.home_model_indoor_forecast_12h
                name: Cooling Cap
                type: line
                stroke_dash: 6
                data_generator: |
                  const times = entity.attributes.times || [];
                  const cap = entity.attributes.cap_f ?? 80;
                  return times.map(t => [new Date(t).getTime(), cap]);
              - entity: sensor.home_model_indoor_forecast_12h
                name: Heating Floor
                type: line
                stroke_dash: 6
                data_generator: |
                  const times = entity.attributes.times || [];
                  const floor = entity.attributes.floor_f ?? 62;
                  return times.map(t => [new Date(t).getTime(), floor]);
              - entity: sensor.home_model_outdoor_forecast_12h
                name: Outdoor (Hourly)
                type: line
                opacity: 0.35
                stroke_dash: 4
                data_generator: >
                  if (!entity.attributes.series) return [];

                  return entity.attributes.series.map(p => [new
                  Date(p.t).getTime(), p.y]);
              - entity: sensor.home_model_external_forecast_avg
                name: AccuWeather Forecast
                type: line
                opacity: 0.6
                stroke_dash: 3
                color: '#4caf50'
                data_generator: >
                  if (!entity.attributes || !entity.attributes.temps) return [];
                  const temps = entity.attributes.temps;
                  const now = new Date();
                  return temps.map((temp, i) => [
                    new Date(now.getTime() + (i * 60 * 60 * 1000)).getTime(),
                    temp
                  ]);
        grid_options:
          columns: full
        columns: 1
    column_span: 4
  - type: grid
    columns: 1
    cards:
      - type: heading
        heading: Climate Model
      - type: tile
        entity: sensor.home_model_control_recommendation
        features_position: bottom
        vertical: true
        hide_state: false
        name: Predicted HVAC Mode
        grid_options:
          columns: full
      - type: entities
        title: HVAC Recommendations & Runtime
        show_header_toggle: false
        entities:
          - entity: sensor.home_model_ideal_cool_start_time
            name: Cooling Start Time
          - entity: sensor.home_model_cool_off_time
            name: Cooling End Time
          - entity: sensor.home_model_ideal_heat_start_time
            name: Heating Start Time
          - entity: sensor.home_model_heat_off_time
            name: Heating End Time
          - type: divider
          - entity: sensor.home_model_time_to_cap_minutes
            name: Time To Cooling Cap (idle)
          - entity: sensor.home_model_time_to_floor_minutes
            name: Time To Heating Floor (idle)
          - type: divider
          - entity: sensor.home_model_ml_enhanced_prediction
            name: ML Enhanced Next Prediction
          - entity: sensor.home_model_comfort_violation
            name: Comfort Band Violation Alert
      - type: entities
        title: Comfort Band
        show_header_toggle: false
        entities:
          - entity: input_number.home_model_comfort_cap
            name: Cooling Cap (°F)
          - entity: input_number.home_model_heat_min_f
            name: Heating Floor (°F)
          - entity: input_number.home_model_forecast_hours
            name: Forecast Horizon (hours)
      - type: entities
        title: Model Parameters
        show_header_toggle: false
        entities:
          - entity: sensor.home_model_tau_hours
            name: τ (hours)
          - entity: sensor.home_model_k_heat
            name: k_heat (°F/min)
          - entity: sensor.home_model_k_cool
            name: k_cool (°F/min)
          - entity: sensor.home_model_bias
            name: bias (°F/min)
          - entity: sensor.home_model_k_enthalpy
            name: k_enthalpy (°F/min per kJ/kg)
          - entity: sensor.home_model_k_solar
            name: k_solar (°F/min per W/m²)
          - entity: sensor.home_model_samples
            name: RC Model Samples
          - entity: sensor.home_model_fit_loss
            name: RC Model Fit Loss
      - type: entities
        title: Machine Learning Status
        show_header_toggle: false
        entities:
          - entity: sensor.home_model_ml_status
            name: ML Training Status
          - entity: sensor.home_model_comfort_score
            name: Current Comfort Score
          - entity: sensor.home_model_energy_efficiency
            name: Energy Efficiency Score
      - type: glance
        title: Short-Horizon Checkpoints
        entities:
          - entity: sensor.home_temp_plus_30m_model
            name: +30m
          - entity: sensor.home_temp_plus_60m_model
            name: +60m
          - entity: sensor.home_temp_plus_180m_model
            name: +180m
    column_span: 4
